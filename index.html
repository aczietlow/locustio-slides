<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Load testing</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/mindgrub.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class='footer'>
				<div class="left">
					<a href="https://www.mindgrub.com"><img src="assets/mindgrub-logo.png"/></a>
				</div>
				<div class="right">
					<span><a href="https://aczietlow.github.io/PredictionIO-presentation/">Locustio</a></span>
					<span><a href="https://twitter.com/aczietlow">@aczietlow</a></span>
					<span><a href="https://twitter.com/kesoleil">@kesoleil</a></span>
				</div>
			</div>
			<div class="slides">
				<!-- Introduction -->
				<section>
					<section>
						<h2>Avoiding launch fails with load testing</h2>
						<h4>Locustio</h4>
					</section>
					<section>
						<h2>Abide by our code of Conduct</h2>
						<p>All attendees, speakers, sponsors, and volunteers at our conference are required to agree with the following code of conduct.

							If you need to report an incident, ask one of the volunteers in the registration area to contact us or call 321-396-2340.</p>
						<p><a href="https://www.fldrupal.camp/community/code-conduct">https://www.fldrupal.camp/community/code-conduct</a></p>
					</section>
					<section>
						<img width="30%" data-src="assets/kaylan_w.png" alt="Mug shot of Kaylan" />
						<h2><a href="https://twitter.com/kesoleil">@kesoleil</a></h2>
						<span>Senior Customer Success Manager, <a href="https://pantheon.io">Pantheon</a></span>
					</section>
					<section data-background="assets/pantheon_background.png">
						<h6 style="color:white; padding-left:10%; padding-top: 45%;"><a href="https://grnh.se/75d2a6781">Now Hiring</a></h6>
						<aside class="notes">
							<ul>
								<li>kaylan slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<img data-src="assets/chris_z.jpg" alt="Mug shot of Chris Z" />
						<h2><a href="https://twitter.com/aczietlow">@aczietlow</a></h2>
						<span>Engineer Manager, <a href="https://www.mindgrub.com">Mindgrub</a></span>
					</section>
					<section>
						<h2>Mindgrub</h2>
						<p>Technical Agency; Drupal and Beyond</p>
						<h6 class="fragment blink">Now Hiring</h6>
						<div>
							<img width="40%" data-src="assets/rokisky-pong.png" alt="Mindgrub office and culture ping pong table"/>
						</div>
						<aside class="notes">
							<ul>
								<li>web</li>
								<ul>
									<li>Drupal</li>
									<li>Wordpress</li>
									<li>React, angular, & node</li>
									<li>angular</li>
								</ul>
								<li>mobile</li>
								<ul>
									<li>Android, iOS</li>
									<li></li>
								</ul>
								<li>other</li>
								<ul>
									<li>Written firmware</li>
									<li>slack bots</li>
									<li>Building a robot to deliver snax</li>
								</ul>
							</ul>
						</aside>
					</section>
				</section>

				<!-- Foundation of WTF we're doing here -->
				<section>
					<section>
						<h2>load testing</h2>
						<img class="fragment" data-src="assets/but_why.gif" alt="but why though" />
					</section>
					<section>
						<h2>Lexicon</h2>
						<dl>
							<dt class="fragment">performance testing</dt>
							<dd class="fragment">determine resource usage, scability, and reliability under different given circumstances</dd>
							<dt class="fragment">load testing</dt>
							<dd class="fragment">Continously increase the stress on the system until failure to learn the limits</dd>
							<dt class="fragment">stress testing</dt>
							<dd class="fragment">Place the system under stress, and begin overloading system components</dd>
						</dl>
						<aside class="notes">
							<ul>
								<li>Chris Slide</li>
								<li>Talk about what each is used to determine</li>
								<li>The value derived from such</li>
								<li>Examples of usages</li>
							</ul>
						</aside>
					</section>
				</section>

				<!-- Story time -->
				<section>
					<section>
						<h2>Healthcare.gov</h2>
						<img class="fragment" width="70%" data-src="assets/healthcare-gov.png" alt="but why though" />
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Healthcare.gov</h2>
						<ul>
							<li>250,000 users caused downtime within 2 hours of launch</li>
							<li>Site could handle even fewer authenticated users</li>
							<li>6 users were able to submit applications on first day</li>
							<li>By Dec 1, site could handle 35k concurrent users</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Healthcare.gov</h2>
						<p>Launch day was mandated in ACA, no wiggle room.

Site launched:</p>
						<ul>
							<li>not feature complete</li>
							<li>minimal testing</li>
							<li>minimal troubleshooting</li>
							<li>with no regard to results of testing and troubleshooting</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Salesforce + Drupal connection under load</h2>
						<p>Background:</p>
						<ul>
							<li>Organization funded by donations</li>
							<li>Authenticated users on site</li>
							<li>User data retrieved from Salesforce on login</li>
							<li>User data not updating correctly on live site</li>
							<li>Difficult to debug outside of Prod</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Salesforce + Drupal connection under load</h2>
						<p>How did we fix it?</p>
						<ul>
							<li>Use load test framework to put cloned site under load</li>
							<li>Mimic users logging in and out of system</li>
							<li>Watch in New Relic and with xdebug in real time</li>
							<li>Ability to independently test theories and potential fixes </li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>GDPR Pop-ups and Caching</h2>
						<p>Background:</p>
						<ul>
							<li>International site</li>
							<li>~50k Anonymous users per day</li>
							<li>Minimal content updates</li>
							<li>Primarily served from CDN</li>
							<li>Undergoing a relaunch from D7 to D8 </li>
							<li>must be GDPR compliant, added cookie notification pop-up to website</li>
							<li>Load test planned ~1 week before launch</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>GDPR Pop-ups and Caching</h2>
						<p>Load test results indicated very poor site performance.</p>
						<ul>
							<li>Cache hit rate of less than 5% </li>
							<li>Site running out of PHP workers </li>
							<li>mySQL layer showing distress in New Relic</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>GDPR Pop-ups and Caching</h2>
						<p>So what happened?</p>
						<ul>
							<li>Developers identified that GDPR pop-up was interfering with proper site caching </li>
							<li>Were able to implement code fixes in the week before launch</li>
							<li>Ran a shortened Load Test to verify fix before launch</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Kaylan Slide</li>
							</ul>
						</aside>
					</section>
				</section>
				<section>
					<section>
						<h2>When to load test</h2>
						<ul>
							<li class="fragment">new launches</li>
							<li class="fragment">feature release</li>
							<li class="fragment">bug fixes</li>
							<li class="fragment">major marketing event</li>
							<li class="fragment">part of CI</li>
							<li class="fragment">Debugging problems that occur only under load</li>
						</ul>

					</section>
					<section>
						<h2>Testing plan</h2>
						<ul>
							<li class="fragment">Have a plan</li>
							<li class="fragment">execute it!</li>
						</ul>
					</section>
					<section>
						<h2>Why locust over others</h2>
						<ul>
							<li class="fragment">We didn't want to have to write and maintain clunky XML files</li>
							<li class="fragment">We liked locust distributed scalability</li>
							<li class="fragment">Concurrency ++</li>
							<li class="fragment">Loathe yet another DSL in XML</li>
							<li class="fragment">We like python</li>
							<li class="fragment">Open source</li>
						</ul>
					</section>
				</section>

				<!-- Live demo time -->
				<section>
					<section>
						<h2>Live Demo Time?</h2>
					</section>
				</section>

				<!-- Sandwich boi project -->
				<section>
					<section>
						<h2>Life saver</h2>
						<ul>
							<li class="fragment">Drupal site</li>
							<li class="fragment">catalogs large data collections</li>
							<li class="fragment">Paid subscription service</li>
							<li class="fragment">4 years old</li>
							<li class="fragment">moderate success and growth</li>
						</ul>
					</section>
					<section>
						<img class="fragment" data-src="assets/dwp-rds-spike.png" alt="rds cpu" />
						<ul class="fragment">
							<li>db.r4.large instances</li>
							<li>2 cpu, 16 GB ram</li>
						</ul>
					</section>
					<section>
						<h2>Panic</h2>
						<ul>
							<li class="fragment">more app containers?</li>
							<li class="fragment">Okay all of the app containers, NOW</li>
							<li class="fragment">more database power</li>
							<li class="fragment">Go from db.r4.large instances, to db.r4.8xlarge</li>
							<li class="fragment">16 core, 244 Mem</li>
						</ul>
					</section>
					<section>
						<img class="fragment" data-src="assets/jmeter-results.png" alt="rds cpu" />
					</section>
					<section>
						<pre><code data-trim contenteditable>
SELECT node.nid                                                  AS nid,
       node.title                                                AS node_title,
       ships_cargo_counts_node.percentage                    AS ships_cargo_counts_node_percentage,
       ships_cargo_counts_node.count                         AS ships_cargo_counts_node_count,
       ships_cargo_counts_node.ships_limit                AS ships_cargo_counts_node_ships_limit,
       food_logs_node.percentage                          AS food_logs_node_percentage,
       food_logs_node.count                               AS food_logs_node_count,
       food_logs_node.ships_limit                      AS food_logs_node_ships_limit,
       ships_subscription_counts_node.total_subscriptions     AS ships_subscription_counts_node_total_subscriptions,
       ships_subscription_counts_node.plus_subscriptions      AS ships_subscription_counts_node_plus_subscriptions,
       ships_subscription_counts_node.executive_subscriptions AS ships_subscription_counts_node_executive_subscriptions,
       ships_subscription_counts_node.family_subscriptions    AS ships_subscription_counts_node_family_subscriptions
FROM node node
       LEFT JOIN (SELECT r.nid                                                                     AS nid,
                         limit_table.field_number_cargos_allowed_value                            AS ships_limit,
                         COUNT(s.id)                                                               AS count,
                         CASE
                           WHEN limit_table.field_number_cargos_allowed_value IS NULL OR
                                limit_table.field_number_cargos_allowed_value = 0 THEN 0
                           ELSE (COUNT(s.id) / limit_table.field_number_cargos_allowed_value) END AS percentage
                  FROM node r
                         LEFT OUTER JOIN og_membership g
                                         ON g.gid = r.nid AND g.group_type = 'node' AND g.entity_type = 'node'
                         LEFT OUTER JOIN node o ON o.nid = g.etid
                         LEFT OUTER JOIN field_data_field_email_cargos e
                                         ON e.entity_type = 'node' AND e.entity_id = o.nid
                         LEFT OUTER JOIN eck_search_record s ON s.id = e.field_email_cargos_target_id
                         LEFT OUTER JOIN field_data_field_number_cargos_allowed limit_table
                                         ON limit_table.entity_type = 'node' AND limit_table.entity_id = r.nid
                  WHERE (r.type = 'ships')
                  GROUP BY r.nid) ships_cargo_counts_node ON node.nid = ships_cargo_counts_node.nid
       LEFT JOIN (SELECT v_count.ships                                                 AS ships,
                         limit_table.field_live_data_search_limit_value                   AS ships_limit,
                         CASE WHEN v_date.date != '05/2019' THEN 0 ELSE v_count.count END AS count,
                         CASE
                           WHEN limit_table.field_live_data_search_limit_value IS NULL OR
                                limit_table.field_live_data_search_limit_value = 0 THEN 0
                           ELSE (CASE WHEN v_date.date != '05/2019' THEN 0 ELSE v_count.count END /
                                 limit_table.field_live_data_search_limit_value) END      AS percentage
                  FROM (SELECT SUBSTRING_INDEX(SUBSTRING_INDEX(v_count.name, '_', 5), '_', -1)  AS ships,
                               SUBSTRING_INDEX(SUBSTRING_INDEX(v_count.value, ';', 1), ':', -1) AS count
                        FROM variable v_count
                        WHERE (v_count.name LIKE 'banana_boat_exteranl_search_ships_%_count' ESCAPE '\\')) v_count
                         INNER JOIN (SELECT SUBSTRING_INDEX(SUBSTRING_INDEX(v_date.name, '_', 5), '_', -1)  AS ships,
                                            SUBSTRING_INDEX(SUBSTRING_INDEX(v_date.value, '"', 2), '"', -1) AS date
                                     FROM variable v_date
                                     WHERE (v_date.name LIKE 'banana_boat_exteranl_search_ships_%_date' ESCAPE '\\')) v_date
                                    ON v_count.ships = v_date.ships
                         LEFT OUTER JOIN field_data_field_live_data_search_limit limit_table
                                         ON limit_table.entity_type = 'node' AND
                                            limit_table.entity_id = v_count.ships) food_logs_node
                 ON node.nid = food_logs_node.ships
       LEFT JOIN (SELECT d.*, r.nid AS nid
                  FROM node r
                         INNER JOIN (SELECT d.ships AS ships, MAX(d.id) AS id
                                     FROM ships_data d
                                     GROUP BY d.ships) rd ON r.nid = rd.ships
                         INNER JOIN ships_data d ON d.id = rd.id
                  WHERE (r.type = 'ships')) ships_subscription_counts_node
                 ON node.nid = ships_subscription_counts_node.nid
WHERE (((node.status = '1') AND (node.type IN ('ships'))))
ORDER BY node_title ASC
LIMIT 25 OFFSET 0;
						</code>
						</pre>
					</section>
					<section>
						<pre><code data-trim contenteditable>
// AFAICT: This just works, but I have no idea how
// I'm scared to touch it.
						</code></pre>
					</section>
					<section>
						<h2>Resolution</h2>
						<ul>
							<li>tl;dr - we were scanning a table that now had 6.8 million rows x * y * z times everytime a user hit their homepage.</li>
						</ul>
					</section>
				</section>
				<section>
					<h2>In conclusion</h2>
					<ul>
						<li class="fragment">Skipping load testing will be expensive later</li>
						<li class="fragment">Locust is amazing</li>
						<li class="fragment">Go forth and do awesome</li>
					</ul>
				</section>
			</div>
		</div>

		<script src="lib/js/jquery-3.3.1.min.js"></script>
		<script src="lib/js/head.min.js"></script>
		<script src="js/mindgrub.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				],
				// slideNumber: true,
				hash: true,
				history: true,


			});
		</script>
		<script>
            // displayed upon load, hides when slide changes
            Reveal.addEventListener('slidechanged', function(event) {
                document.querySelector('.reveal .footer').style.display = 'none';
            });
		</script>
	</body>
</html>
